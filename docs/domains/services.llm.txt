# Services Layer

La couche services contient la logique métier stateless de l'application frontend.

## Principe

**Services vs Composables vs Utils**:
- **Services** (`services/`): Logique métier complexe, stateless, peut être testée indépendamment
- **Composables** (`composables/`): Logique réactive Vue-specific (ref, computed, watch)
- **Utils** (`utils/`): Fonctions utilitaires pures et simples (formatage, parsing)

## Services disponibles

### `autocomplete_service.ts`
Gère l'autocomplétion pour les champs de formulaire.

**Exports**:
- `autocompleteFunctions`: Map des fonctions d'autocomplétion disponibles
- `autocompleteConfigs`: Configuration pour chaque fonction d'autocomplétion
- `AutocompleteFn`: Type pour les fonctions d'autocomplétion

**Utilisation**: Utilisé par les composants de formulaire (ComboboxQuestion) pour charger des suggestions depuis l'API.

### `condition_service.ts`
Évalue les conditions de visibilité des questions.

**Exports**:
- `evaluateCondition(conditionStr, answers)`: Évalue une condition booléenne

**Logique supportée**:
- Opérateurs: `&&`, `||`, `>=`, `<=`, `>`, `<`, `=`, `!=`
- Méthodes: `.includes()`, `.excludes()`

**Utilisation**: Utilisé par `use_survey_visibility` pour déterminer si une question doit être affichée.

### `eligibility_service.ts`
Calcule l'éligibilité aux aides avec Publicodes.

**Exports**:
- `calculateEligibility(surveyId, answers, dispositifsToEvaluate)`: Calcule l'éligibilité
- Types: `DispositifDetail`, `DispositifEligibilityInfo`, `EligibilityResults`

**Processus**:
1. Charge les règles Publicodes pour le simulateur
2. Mappe les réponses du formulaire aux variables Publicodes
3. Évalue chaque dispositif
4. Retourne les dispositifs éligibles, potentiels et inéligibles

**Utilisation**: Utilisé par `use_dynamic_eligibility` et `use_simulation` pour les simulateurs Publicodes.

### `error_tracker_service.ts`
Abstraction pour le tracking d'erreurs.

**Exports**:
- `errorTracker`: Instance du tracker (actuellement console-based)
- `initErrorTracking(user)`: Initialise avec contexte utilisateur
- `trackError(error, context)`: Track une erreur
- `trackMessage(message, level)`: Track un message

**Utilisation**: Peut être remplacé par Sentry en production.

### `formatting_service.ts`
Formate les réponses pour l'affichage.

**Exports**:
- `formatAnswer(simulateurSlug, questionId, value, getAnswer, findQuestionById)`: Formate une réponse

**Gère**:
- Boolean → "Oui"/"Non"
- Number → string
- Checkbox → liste des choix sélectionnés
- Combobox → texte de l'option
- Radio → titre du choix

**Utilisation**: Utilisé par le store surveys pour afficher les réponses formatées.

### `matomo_service.ts`
Service de tracking analytics avec Matomo.

**Exports**:
- `trackEvent(category, action, name, value)`: Track un événement
- `getMatomoCategory(baseId)`: Génère la catégorie Matomo
- `trackSurveyAnswer(simulateurSlug, questionId, questionTitle)`: Track une réponse
- `trackSurveyStart(simulateurSlug)`: Track le démarrage
- `trackSurveySubmit(simulateurSlug)`: Track la soumission
- `trackEligibility(simulateurSlug, aidesLength)`: Track l'éligibilité

**Utilisation**: Utilisé par les composables et composants pour tracker les interactions utilisateur.

### `publicodes_loader_service.ts`
Charge dynamiquement les règles Publicodes.

**Exports**:
- `getPublicodesRules(simulateurSlug)`: Charge les règles pour un simulateur

**Simulateurs supportés**:
- `entreprise-innovation`
- `aom-rennes`
- `aom-bordeaux`

**Utilisation**: Utilisé par `eligibility_service` et les pages de simulateurs.

### `validation_service.ts`
Valide les réponses aux questions.

**Exports**:
- `isAnswerValid(question, answer)`: Vérifie si une réponse est valide

**Validation par type**:
- `radio`, `date`: Valeur non vide
- `boolean`: true ou false
- `checkbox`: Array avec au moins 1 élément
- `number`: Nombre incluant 0
- `combobox`: Valeur définie

**Utilisation**: Utilisé par `use_survey_validation` pour vérifier la complétude du formulaire.

### `openfisca/`
Services pour les calculs OpenFisca.

**Fichiers principaux**:
- `build_calculation_request.ts`: Construit les requêtes OpenFisca
- `beautify_results.ts`: Extrait et formate les résultats
- `standardize_birth_date.ts`: Normalise les dates de naissance
- `request-builder/`: Pattern builder pour construire les requêtes

**Utilisation**: Utilisé par `use_simulation` pour les simulateurs OpenFisca.

## Conventions

### Nommage
- Fichiers: `snake_case_service.ts`
- Exports: fonctions nommées ou classes

### Structure
```typescript
/**
 * Service description
 */

// Imports

// Types/Interfaces (exportés)

// Helper functions (non exportées, internal)

// Main service functions (exportées)
```

### Tests
Les services doivent être testables indépendamment sans mocks Vue.

## Migration depuis utils/composables

Fichiers déplacés:
- `utils/error_tracker.ts` → `services/error_tracker_service.ts`
- `utils/get_publicodes_rules.ts` → `services/publicodes_loader_service.ts`
- `utils/form_validation.ts` → `services/validation_service.ts`
- `utils/evaluate_conditions.ts` → `services/condition_service.ts`
- `utils/autocomplete_functions.ts` → `services/autocomplete_service.ts`
- `utils/openfisca/` → `services/openfisca/`
- `composables/use_matomo_tracking.ts` → `services/matomo_service.ts`
- `composables/use_eligibility_service.ts` → `services/eligibility_service.ts`
- `composables/surveys/use_survey_formatting.ts` → `services/formatting_service.ts`
