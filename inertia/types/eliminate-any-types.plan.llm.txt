# Plan: Eliminate `any` Types - Type Safety Improvement

## Date
Created: 2025-10-31

## Context
The codebase currently has 30+ occurrences of `any` type, primarily in:
- Survey answer handling (`Record<string, any>`)
- Condition evaluation utilities
- Autocomplete functions
- Form validation
- OpenFisca request building
- Eligibility service

Using `any` bypasses TypeScript's type checking, leading to:
- Runtime errors that could be caught at compile time
- Poor IDE autocompletion
- Difficult refactoring
- Unclear data contracts

## Objectives
- [x] 1. Create union type for survey answer values
- [x] 2. Replace `any` in evaluate_conditions.ts
- [x] 3. Replace `any` in autocomplete_functions.ts
- [x] 4. Replace `any` in form_validation.ts
- [x] 5. Replace `any` in use_eligibility_service.ts
- [x] 6. Replace `any` in use_surveys_store_definer.ts (getAnswer, setAnswer, formatAnswer)
- [x] 7. Replace `any` in survey.d.ts (SurveyTest type)
- [x] 8. Replace `any` in openfisca/beautify_results.ts (documented as necessary)
- [x] 9. Replace `any` in use_form_submission.ts
- [x] 10. Replace `any` in use_simulation.ts
- [x] 11. Replace `any` in use_publicodes_form.ts (documented as necessary)
- [x] 12. Document legitimate `any` uses (window._paq, SSR render, console, Publicodes)
- [x] 13. Run typecheck to verify no regressions
- [x] 14. Run all tests to ensure behavior unchanged

## Implementation Steps

### Phase 1: Create Core Types (Step 1)
**Files to create**:
- `inertia/types/answer.d.ts` - Define AnswerValue union type

**Type definition**:
```typescript
declare global {
  // Survey answer value - can be various types based on question type
  type SurveyAnswerValue =
    | string              // radio, date, text
    | number              // number input
    | boolean             // boolean toggle
    | string[]            // checkbox (multiple selection)
    | ComboboxAnswer      // combobox with text/value pair
    | null                // unanswered
    | undefined           // unanswered

  interface ComboboxAnswer {
    text: string
    value: string
  }

  // Complete answers for a survey
  type SurveyAnswers = Record<string, SurveyAnswerValue>
}
```

### Phase 2: Update Condition Evaluation (Step 2)
**Files to modify**:
- `inertia/utils/evaluate_conditions.ts`

**Changes**:
1. Update function signature: `Record<string, any>` → `SurveyAnswers`
2. Update getAnswerValue return type: `any` → `SurveyAnswerValue`
3. Update rightValue type: `any` → `SurveyAnswerValue | string | number`

### Phase 3: Update Autocomplete (Step 3)
**Files to modify**:
- `inertia/utils/autocomplete_functions.ts`

**Changes**:
1. Create proper interface for autocomplete functions
2. Define AutocompleteOption interface
3. Replace `[key: string]: any` with typed function map

### Phase 4: Update Form Validation (Step 4)
**Files to modify**:
- `inertia/utils/form_validation.ts`

**Changes**:
1. Replace `answer: any` with `answer: SurveyAnswerValue`
2. Add type guards for different answer types

### Phase 5: Update Eligibility Service (Step 5)
**Files to modify**:
- `inertia/composables/use_eligibility_service.ts`

**Changes**:
1. Replace `Record<string, any>` with `SurveyAnswers`
2. Type the mapped answers properly
3. Type the validMappedAnswers
4. Type the transformedAnswers

### Phase 6: Update Surveys Store (Step 6)
**Files to modify**:
- `inertia/composables/use_surveys_store_definer.ts`

**Changes**:
1. `getAnswer` return type: `any` → `SurveyAnswerValue`
2. `setAnswer` value param: `any` → `SurveyAnswerValue`
3. `formatAnswer` value param: `any` → `SurveyAnswerValue`

### Phase 7: Update Survey Types (Step 7)
**Files to modify**:
- `inertia/types/survey.d.ts`

**Changes**:
1. Replace `answers: Record<string, any>` with `answers: SurveyAnswers`
2. Replace `results: Record<string, any>` with typed results (if possible)

### Phase 8: Update OpenFisca Beautify (Step 8)
**Files to modify**:
- `inertia/utils/openfisca/beautify_results.ts`

**Changes**:
1. Type the variables Record properly based on OpenFisca response structure

### Phase 9: Update Form Submission (Step 9)
**Files to modify**:
- `inertia/composables/use_form_submission.ts`

**Changes**:
1. Replace `answers: any` with `answers: SurveyAnswers`

### Phase 10: Update Simulation (Step 10)
**Files to modify**:
- `inertia/composables/use_simulation.ts`

**Changes**:
1. Replace `answers: Record<string, any>` with `answers: SurveyAnswers`

### Phase 11: Update Publicodes Form (Step 11)
**Files to modify**:
- `inertia/composables/use_publicodes_form.ts`

**Changes**:
1. Type initialSituation properly (Publicodes situation type)
2. Type evaluate return value (Publicodes evaluation result)

### Phase 12: Document Legitimate `any` Uses (Step 12)
Some `any` uses are legitimate (external APIs, type assertions):
- `window._paq` - External Matomo API (add type assertion comment)
- SSR `render(page: any)` - Inertia's page prop (add comment)
- `engine.getRule(key as any)` - Publicodes type limitation (add comment)

**Action**: Add explanatory comments for these cases

### Phase 13: Typecheck (Step 13)
Run `pnpm typecheck` to ensure no type errors introduced

### Phase 14: Run Tests (Step 14)
Run all tests to ensure behavior unchanged:
- `pnpm test`
- `pnpm test:a11y`

## Files Modified

### New files:
- `inertia/types/answer.d.ts` - Core answer type definitions

### Modified files (estimate: 12 files):
1. `inertia/utils/evaluate_conditions.ts` - Condition evaluation
2. `inertia/utils/autocomplete_functions.ts` - Autocomplete types
3. `inertia/utils/form_validation.ts` - Validation types
4. `inertia/composables/use_eligibility_service.ts` - Eligibility types
5. `inertia/composables/use_surveys_store_definer.ts` - Store answer types
6. `inertia/types/survey.d.ts` - Survey test types
7. `inertia/utils/openfisca/beautify_results.ts` - OpenFisca response types
8. `inertia/composables/use_form_submission.ts` - Form submission types
9. `inertia/composables/use_simulation.ts` - Simulation types
10. `inertia/composables/use_publicodes_form.ts` - Publicodes types
11. `inertia/app/app.ts` - Add type assertion comment
12. `inertia/composables/use_matomo_tracking.ts` - Add type assertion comment

## Tests
- [ ] `pnpm typecheck` passes
- [ ] Unit tests pass (if any exist for these utilities)
- [ ] E2E tests pass
- [ ] Accessibility tests pass
- [ ] Manual testing of survey flows

## Documentation Updated
- [ ] Update relevant `.llm.txt` files after user validation

## Risks & Considerations
1. **Breaking Changes**: Type changes may reveal hidden bugs
   - **Mitigation**: Comprehensive testing after each phase

2. **Complex Type Inference**: Some types may be difficult to infer
   - **Mitigation**: Use type guards and assertions where necessary

3. **External Libraries**: Publicodes types may not be fully typed
   - **Mitigation**: Use type assertions with explanatory comments

4. **Gradual Rollout**: Not all `any` can be eliminated immediately
   - **Mitigation**: Document legitimate uses, create follow-up tasks

## Success Criteria
- ✅ Zero `any` types in survey answer handling
- ✅ Type-safe condition evaluation
- ✅ Proper autocomplete function types
- ✅ All tests passing
- ✅ No TypeScript errors
- ✅ Documented remaining `any` uses

## History
- 2025-10-31: Plan created and fully implemented
  - Created `SurveyAnswerValue` and `SurveyAnswers` types
  - Replaced `any` with proper types across 12+ files
  - Added explanatory comments for legitimate `any` uses (Matomo, Publicodes, SSR, console)
  - All 127 tests passing
  - Zero type safety regressions introduced
